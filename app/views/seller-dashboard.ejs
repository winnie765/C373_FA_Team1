<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Seller Dashboard</title>
  <link rel="stylesheet" href="/public/css/style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.4/ethers.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="section-head">
      <div>
        <h2>Seller Dashboard</h2>
        <p class="muted">Manage events and ticket types. Connect wallet to add ticket types on-chain.</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-dark" type="button" id="connectWalletBtn">Connect MetaMask</button>
        <form method="POST" action="/seller/logout" class="logout-form" style="display:inline;">
          <button class="btn btn-logout" type="submit">Log Out</button>
        </form>
      </div>
    </div>

    <!-- Wallet Status -->
    <div class="wallet-banner" id="walletBanner">
      <span class="status-dot disconnected" id="statusDot"></span>
      <span id="walletText">Wallet not connected - Connect to add ticket types on blockchain</span>
    </div>

    <div class="actions">
      <a class="btn btn-primary" href="/seller/events/new">+ Create Event</a>
    </div>

    <div class="section">
      <div class="section-head">
        <h3>Your Events</h3>
        <span class="count-pill"><%= events.length %> total</span>
      </div>
      <div class="grid">
        <% events.forEach(event => { %>
          <div class="card" data-event-id="<%= event.id %>" data-chain-event-id="<%= event.chainEventId ?? (event.id - 1) %>">
            <div class="card-body">
              <div class="card-top">
                <div>
                  <div class="card-title"><%= event.title %></div>
                  <div class="muted small"><%= event.date || "TBD" %> • <%= event.venue || "Venue TBD" %></div>
                  <% if (event.seller) { %>
                    <div class="muted small">Seller: <%= event.seller.slice(0,6) %>...<%= event.seller.slice(-4) %></div>
                  <% } %>
                  <% if (event.chainEventId !== null && event.chainEventId !== undefined) { %>
                    <div class="muted small" style="color: #10b981;">✓ On-chain (ID: <%= event.chainEventId %>)</div>
                  <% } else { %>
                    <div class="muted small" style="color: #f59e0b;">⚠ Off-chain only</div>
                  <% } %>
                </div>
                <span class="badge ok"><%= (event.ticketTypes || []).length %> types</span>
              </div>

              <div class="ticket-grid">
                <% (event.ticketTypes || []).forEach(t => { %>
                  <div class="pitem">
                    <div class="card-title"><%= t.name %></div>
                    <div class="muted small">Price: <%= t.priceSGD %> ETH • Supply: <%= t.sold %>/<%= t.maxSupply %></div>
                    <% if (t.chainTypeId !== null && t.chainTypeId !== undefined) { %>
                      <div class="muted small" style="color: #10b981;">✓ On-chain</div>
                    <% } %>
                  </div>
                <% }) %>
                <% if (!(event.ticketTypes || []).length) { %>
                  <div class="muted small">No ticket types yet.</div>
                <% } %>
              </div>

              <div class="add-type-form" data-event-id="<%= event.id %>">
                <div class="mini-title">Add Ticket Type</div>
                <label class="auth-label">
                  Name
                  <input class="auth-input type-name" type="text" placeholder="VIP, General, etc." required />
                </label>
                <label class="auth-label">
                  Price (ETH)
                  <input class="auth-input type-price" type="number" step="0.0001" placeholder="0.01" required />
                </label>
                <label class="auth-label">
                  Max Supply
                  <input class="auth-input type-supply" type="number" min="1" placeholder="100" required />
                </label>
                <div class="type-progress" style="display:none;"></div>
                <button class="btn btn-dark add-type-btn" type="button">Add Type (on-chain)</button>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    </div>
  </div>

<style>
  .header-actions {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .wallet-banner {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    background: rgba(0,0,0,0.2);
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px;
  }

  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .status-dot.disconnected {
    background: #ef4444;
  }

  .status-dot.connected {
    background: #10b981;
  }

  .type-progress {
    padding: 8px;
    margin: 8px 0;
    border-radius: 4px;
    font-size: 13px;
  }

  .type-progress.loading {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
  }

  .type-progress.success {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
  }

  .type-progress.error {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
  }
</style>

<script>
  let connectedWallet = null;
  let ticketContract = null;

  // Load contract
  async function loadContract() {
    const deployed = await fetch("/blockchain/web3/deployed.json")
      .then(r => r.ok ? r.json() : null)
      .catch(() => null);

    if (!deployed?.TicketNFT?.address) {
      const artifact = await fetch("/blockchain/build/contracts/TicketNFT.json")
        .then(r => r.ok ? r.json() : null)
        .catch(() => null);

      if (!artifact?.abi) return null;

      const networks = artifact.networks || {};
      const networkId = await window.ethereum.request({ method: "net_version" });
      let address = networks?.[networkId]?.address;

      if (!address) {
        const entries = Object.values(networks);
        if (entries.length === 1) address = entries[0]?.address;
      }

      if (!address) return null;
      return { address, abi: artifact.abi };
    }

    const abi = await fetch("/blockchain/web3/abi/TicketNFT.json")
      .then(r => r.ok ? r.json() : null)
      .catch(() => null);

    if (!abi) return null;
    return { address: deployed.TicketNFT.address, abi };
  }

  // Connect wallet
  document.getElementById('connectWalletBtn').addEventListener('click', async () => {
    if (!window.ethereum) {
      alert('Please install MetaMask!');
      return;
    }

    try {
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      connectedWallet = accounts[0];

      document.getElementById('statusDot').className = 'status-dot connected';
      document.getElementById('walletText').textContent = `Connected: ${connectedWallet.slice(0,6)}...${connectedWallet.slice(-4)}`;
      document.getElementById('connectWalletBtn').textContent = 'Connected';
      document.getElementById('connectWalletBtn').disabled = true;

      const contractData = await loadContract();
      if (contractData) {
        const provider = new ethers.BrowserProvider(window.ethereum);
        const signer = await provider.getSigner();
        ticketContract = new ethers.Contract(contractData.address, contractData.abi, signer);
        console.log('Contract loaded:', contractData.address);
      }
    } catch (err) {
      console.error(err);
      alert('Failed to connect: ' + err.message);
    }
  });

  // Add ticket type buttons
  document.querySelectorAll('.add-type-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const form = this.closest('.add-type-form');
      const card = this.closest('.card');
      const eventId = card.dataset.eventId;
      const chainEventId = card.dataset.chainEventId;

      const name = form.querySelector('.type-name').value.trim();
      const price = form.querySelector('.type-price').value;
      const supply = form.querySelector('.type-supply').value;

      if (!name || !price || !supply) {
        alert('All fields are required');
        return;
      }

      if (!connectedWallet) {
        alert('Please connect your wallet first');
        return;
      }

      const progressEl = form.querySelector('.type-progress');
      progressEl.style.display = 'block';
      progressEl.className = 'type-progress loading';
      progressEl.textContent = 'Creating ticket type on blockchain...';

      this.disabled = true;

      let chainTypeId = null;

      try {
        // Create on blockchain
        if (ticketContract && chainEventId !== 'null' && chainEventId !== 'undefined') {
          const priceWei = ethers.parseEther(price);
          const tx = await ticketContract.addTicketType(
            Number(chainEventId),
            name,
            priceWei,
            Number(supply)
          );

          progressEl.textContent = 'Waiting for confirmation...';
          const receipt = await tx.wait();

          // Parse TicketTypeAdded event
          for (const log of receipt.logs) {
            try {
              const parsed = ticketContract.interface.parseLog(log);
              if (parsed?.name === 'TicketTypeAdded') {
                chainTypeId = Number(parsed.args.typeId);
                break;
              }
            } catch (e) {}
          }

          progressEl.textContent = `On-chain success! (Type ID: ${chainTypeId})`;
        } else {
          progressEl.textContent = 'Event not on chain, saving off-chain only...';
        }

        // Save to backend
        console.log('[AddType] Saving to backend:', { eventId, name, priceSGD: Number(price), maxSupply: Number(supply), chainTypeId });

        const response = await fetch(`/seller/events/${eventId}/types`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            priceSGD: Number(price),
            maxSupply: Number(supply),
            chainTypeId
          })
        });

        const result = await response.json();
        console.log('[AddType] Backend response:', response.status, result);

        if (response.ok && result.success) {
          progressEl.className = 'type-progress success';
          progressEl.textContent = chainTypeId !== null
            ? `Ticket type added! (Chain ID: ${chainTypeId})`
            : 'Ticket type added (off-chain)';

          setTimeout(() => location.reload(), 1500);
        } else {
          throw new Error(result.error || 'Failed to save');
        }
      } catch (err) {
        console.error('[AddType] Error:', err);
        progressEl.className = 'type-progress error';
        progressEl.textContent = 'Error: ' + (err.reason || err.message);
        this.disabled = false;
      }
    });
  });
</script>

</body>
</html>
